<?php //no dynamic id which generated by method uniqid, if necessary, the elements id should be dynamic ?>
<?php if ($longitude && $latitude) : ?>
<div class="googleMap mb30">
	<h2 class="h2Tit">地图</h2>
	<div class="bd">
		<div class="box">
			<div id="mapPoint" style="height: 270px;"></div>
			<div class="ckdt"><a href="javascript:;" id="showBiggerMap">查看大图</a></div>
		</div>
		<input type="hidden" value="" id="longitude" name="longitude">
		<input type="hidden" value="" id="latitude" name="latitude">
		<input type="hidden" value="<?=$address ?>" id="sAddress" name="sAddress">
		<input type="hidden" value="<?=$pro ?>" id="pro" name="pro">
		<div class="mark"><span class="zs">注：地图位置标注仅供参考，具体情况以实际道路标实信息为准</span></div>
	</div>
</div>
<?php //display and edit bigger map ?>
<div class="popBox" id="box_map">
	<div class="bd w750">
		<div class="popGoogleMap">
			<h2><?=$name ?></h2>
			<?php if($canedit) : ?>
			<span id="btnEditPosition" style="cursor: pointer;">修改标注</span>
			<div id="bm_editbox" style="display: none;">
				<h3>地址：<?=$address ?>（<span class="cBlue" id="btnMarkMap" style="cursor: pointer;">地图上标注</span>）</h3>
				<div class="searchMap">
					<input type="text" class="textInput" id="txtNewAddress" />
					<input type="submit" class="searchBtn" value="" id="btnMarkNewAddress" />
					<span class="tips">搜索地址解析的格式如下：省+城市+区县+街道<em class="emTop">◆</em></span>
				</div>
			</div>
			<?php endif; ?>
			<div class="mapBox" id="popmap" style="height:400px;"></div>
		</div>
		<span class="closeBtn" id="bm_closeBtn">关闭</span>
	</div>
</div>

<script type="text/javascript" src="http://api.map.baidu.com/api?v=1.3&services=true"></script>
<script type="text/javascript">
	var initlong = <?=$longitude ?>;
	var initlat = <?=$latitude ?>;				
	var tid = "<?=$tid ?>";
	var map = '';
	var point = '';
	var opts = '';
	var marker = '';
	function markOnMap(mapId, allowDrag) {
		if(! mapId) return false;
		if(allowDrag) {
			if(! map || ! marker) return false;
			map.enableScrollWheelZoom();
			marker.enableDragging(true); // 设置标注可拖拽
			opts = {
				width : 110,     // 信息窗口宽度
				height: 50,     // 信息窗口高度
				title : "提示信息"  // 信息窗口标题
			}
			var infoWindow = new BMap.InfoWindow("拖动此标注更改<?=$modname ?>位置", opts);  // 创建信息窗口对象
			marker.addEventListener("mouseup", function(){
				var position = marker.getPosition();
				var t = confirm("是否将新位置设置为此<?=$modname ?>的默认位置？");
				if(t==true){    											
					marker.disableDragging(true); // 设置标注不可拖拽
					marker.removeEventListener("mouseup"); //remove event
					jQuery("#longitude").val(position['lng']);
					jQuery("#latitude").val(position['lat']);
					jQuery.get('forum.php?ctl=<?=$modstr ?>&act=editmap&tid='+tid, {lng: position['lng'], lat: position['lat']}, function(){
						showDialog("您的修改已提交,刷新页面可看最新效果！","notice");
						jQuery('#bm_editbox, #div_black, #box_map').hide();
						jQuery('#btnEditPosition').show();
						marker.closeInfoWindow(infoWindow);
						map.disableScrollWheelZoom();
					});
				}
			});					
			marker.openInfoWindow(infoWindow);
		}
		else {
			map = new BMap.Map(mapId);
			point = new BMap.Point(initlong, initlat);
			map.centerAndZoom(point, 15);
			map.disableDoubleClickZoom(); // 禁用双击放大
			opts = {type: BMAP_NAVIGATION_CONTROL_SMALL}
			map.addControl(new BMap.NavigationControl(opts));
			marker = new BMap.Marker(point); // 创建标注
			map.addOverlay(marker); // 将标注添加到地图中
		}
	}

	jQuery(document).ready(function() {
		markOnMap('mapPoint', false);

		jQuery('#showBiggerMap').click(function() {
			jQuery("#div_black, #box_map").fadeIn(200);
			markOnMap('popmap', false);

			<?php if($canedit) : ?>
			jQuery('#btnEditPosition').click(function(){
				markOnMap('popmap', true);
				jQuery('#bm_editbox').show();
				jQuery(this).hide();
			});
			<?php endif;?>
		});
		<?php if($canedit) : ?>
		jQuery('#btnMarkMap').click(function(){
			jQuery("#popmap").html('');
			var pro = jQuery("#pro").val();

			map = new BMap.Map("popmap");            // 创建Map实例
			map.centerAndZoom(pro,15);
			map.addControl(new BMap.NavigationControl());
			map.enableScrollWheelZoom();

			//创建地址解析的实例
			var myGeo = new BMap.Geocoder();
			var address = jQuery("#sAddress").val();
			
			myGeo.getPoint(address, function(point){
			  if (point) {
				map.centerAndZoom(point, 15);
				marker = new BMap.Marker(point);
				map.addOverlay(marker);

				//init edit status
				markOnMap('popmap', true);
			  }else{
				alert("数据错误,加载失败！");
			  }
			}, pro);
		});

		jQuery('#btnMarkNewAddress').click(function(){
			var newAddress = jQuery('#txtNewAddress').val();
			if(! newAddress){
				return false;
			}
			jQuery("#popmap").html("");
			var pro = jQuery('#pro').val();

			map = new BMap.Map("popmap");            // 创建Map实例
			map.centerAndZoom(pro,15);									
			map.addControl(new BMap.NavigationControl());
			map.enableScrollWheelZoom();
			//创建地址解析的实例
			var myGeo = new BMap.Geocoder();
			myGeo.getPoint(newAddress, function(point){		
			  if (point) {
				map.centerAndZoom(point, 15);
				marker = new BMap.Marker(point);
				map.addOverlay(marker);

				markOnMap('popmap', true);	
			  }else{
				alert("数据错误,加载失败！");
			  }
			}, pro);
		});
		<?php endif; ?>
	});
</script>
<?php endif; ?>